<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mlrMBO and the command line • mlrMBO</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="mlrMBO and the command line">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">mlrMBO</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../articles/mlrMBO.html">
    <span class="fa fa-bolt"></span>
     
    Quickstart
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-text-o"></span>
     
    Topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/supplementary/mixed_space_optimization.html">Mixed Space Optimization</a>
    </li>
    <li>
      <a href="../../articles/supplementary/parallelization.html">Parallelization</a>
    </li>
    <li>
      <a href="../../articles/supplementary/noisy_optimization.html">Noisy Optimization</a>
    </li>
    <li>
      <a href="../../articles/supplementary/infill_criteria.html">Infill Criteria</a>
    </li>
    <li>
      <a href="../../articles/supplementary/machine_learning_with_mlrmbo.html">Machine learning with mlrMBO</a>
    </li>
    <li>
      <a href="../../articles/supplementary/human_in_the_loop_MBO.html">Human-in-the-loop MBO</a>
    </li>
    <li>
      <a href="../../articles/supplementary/mlrmbo_and_the_command_line.html">mlrMBO and the Command Line</a>
    </li>
    <li>
      <a href="../../articles/supplementary/adaptive_infill_criteria.html">Adaptive Infill Criteria</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">
    <span class="fa fa-book"></span>
     
    Reference
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mlr-org/mlrMBO">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>mlrMBO and the command line</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/mlrMBO/blob/master/vignettes/supplementary/mlrmbo_and_the_command_line.rmd"><code>vignettes/supplementary/mlrmbo_and_the_command_line.rmd</code></a></small>
      <div class="hidden name"><code>mlrmbo_and_the_command_line.rmd</code></div>

    </div>

    
    
<p>This Vignette demonstrates two ways of interaction through the command line. In the first part the algorithm we want to optimize is a program that we call from the command line. The second part shows how to call R and mlrMBO from the command line so that we don’t have to interact with R at all anymore.</p>
<div id="optimizing-an-algorithm-via-an-cli" class="section level2">
<h2 class="hasAnchor">
<a href="#optimizing-an-algorithm-via-an-cli" class="anchor"></a>Optimizing an algorithm via an CLI</h2>
<p>First of all we need a bash script that we want to optimize. This Vignette is aimed at users of Unix systems (Linux, OSX etc.) but should also be informative for windows users. The following code writes a bash script that uses <code>bc</code> to calculate <span class="math inline">\(sin(x_1-1) + (x_1^2 + x_2^2)\)</span> and writes the result in a text file. This will serve as our target algorithm that we want to optimize.</p>
<div id="the-bash-script" class="section level3">
<h3 class="hasAnchor">
<a href="#the-bash-script" class="anchor"></a>The bash script</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># write bash script</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">lines =<span class="st"> '#!/bin/bash</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="st">fun ()</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="st">{</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="st">  x1=$1</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="st">  x2=$2</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="st">  command="(s($x1-1) + ($x1^2 + $x2^2))"</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="st">  result=$(bc -l &lt;&lt;&lt; $command)</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="st">}</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="st">echo "Start calculation."</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="st">fun $1 $2</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="st">echo "The result is $result!" &gt; "result.txt"</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="st">echo "Finish calculation."</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="st">'</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="kw">writeLines</span>(lines, <span class="st">"fun.sh"</span>)</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="co"># make it executable:</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="kw">system</span>(<span class="st">"chmod +x fun.sh"</span>)</a></code></pre></div>
</div>
<div id="running-the-script-from-r" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-script-from-r" class="anchor"></a>Running the script from R</h3>
<p>The following code is an R function that starts the script, reads the result from the text file and returns it.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(stringi)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">runScript =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  command =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">"./fun.sh %f %f"</span>, x[[<span class="st">'x1'</span>]], x[[<span class="st">'x2'</span>]])</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  error.code =<span class="st"> </span><span class="kw">system</span>(command)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="cf">if</span> (error.code <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="kw">stop</span>(<span class="st">"Simulation had error.code != 0!"</span>)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  }</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  result =<span class="st"> </span><span class="kw">readLines</span>(<span class="st">"result.txt"</span>)</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  <span class="co"># the pattern matches 12 as well as 12.34 and .34</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  <span class="co"># the ?: makes the decimals a non-capturing group.</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  result =<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringi/topics/stri_match">stri_match_first_regex</a></span>(result, <span class="dt">pattern =</span> <span class="st">"</span><span class="ch">\\</span><span class="st">d*(?:</span><span class="ch">\\</span><span class="st">.</span><span class="ch">\\</span><span class="st">d+)?(?=</span><span class="ch">\\</span><span class="st">!)"</span>)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  <span class="kw">as.numeric</span>(result)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">}</a></code></pre></div>
<p>This function uses <code>stringi</code> and <em>regular expressions</em> to match the actual result value in the result file. Depending on the output different strategies to read the result make sense. XML files can usually be accessed with <code><a href="http://www.rdocumentation.org/packages/XML/topics/xmlTreeParse">XML::xmlParse</a></code>, <code><a href="http://www.rdocumentation.org/packages/XML/topics/getNodeSet">XML::getNodeSet</a></code>, <code><a href="http://www.rdocumentation.org/packages/XML/topics/xmlAttrs">XML::xmlAttrs</a></code> etc. using <code>XPath</code> queries. Sometimes <code>read.table()</code> is also sufficient. Another way is to use <code>source</code> if the result actually can be interpreted as valid R code. If, for example, the output is written in a file like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">value1 =<span class="st"> </span><span class="fl">23.45</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">value2 =<span class="st"> </span><span class="fl">13.82</span></a></code></pre></div>
<p>We can easily use <code>source()</code> like that:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">EV =<span class="st"> </span><span class="kw">new.env</span>()</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">eval</span>(<span class="dt">expr =</span> {a =<span class="st"> </span><span class="dv">1</span>}, <span class="dt">envir =</span> EV)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">as.list</span>(EV)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">source</span>(<span class="dt">file =</span> <span class="st">"result.txt"</span>, <span class="dt">local =</span> EV)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">res =<span class="st"> </span><span class="kw">as.list</span>(EV)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="kw">rm</span>(EV)</a></code></pre></div>
<p>which will return a list with the entries <code>$value1</code> and <code>$value2</code>.</p>
</div>
<div id="define-bounds-wrap-function-" class="section level3">
<h3 class="hasAnchor">
<a href="#define-bounds-wrap-function-" class="anchor"></a>Define bounds, wrap function.</h3>
<p>To evaluate the function from within <strong>mlrMBO</strong> it has to be wrapped in <strong>smoof</strong> function. The smoof function also contains information about the bounds and scales of the domain of the objective function defined in a <em>ParameterSet</em>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">library</span>(mlrMBO)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co"># Defining the bounds of the parameters:</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">par.set =<span class="st"> </span><span class="kw">makeParamSet</span>(</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  <span class="kw">makeNumericParam</span>(<span class="st">"x1"</span>, <span class="dt">lower =</span> <span class="dv">-3</span>, <span class="dt">upper =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="kw">makeNumericParam</span>(<span class="st">"x2"</span>, <span class="dt">lower =</span> <span class="fl">-2.5</span>, <span class="dt">upper =</span> <span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co"># Wrapping everything in a smoof function:</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">fn =<span class="st"> </span><span class="kw">makeSingleObjectiveFunction</span>(</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  <span class="dt">id =</span> <span class="st">"fun.sh"</span>,</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  <span class="dt">fn =</span> runScript,</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">  <span class="dt">par.set =</span> par.set,</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">  <span class="dt">has.simple.signature =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">)</a></code></pre></div>
<p>We confirm that the function works as intended and evaluate the initial design:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">des =<span class="st"> </span><span class="kw">generateGridDesign</span>(par.set, <span class="dt">resolution =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">des<span class="op">$</span>y =<span class="st"> </span><span class="kw">apply</span>(des, <span class="dv">1</span>, fn)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">des</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">##   x1   x2         y</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">## 1 -3 -2.5 16.006802</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">## 2  0 -2.5  5.408529</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">## 3  3 -2.5 16.159297</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">## 4 -3  0.0  9.756802</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">## 5  0  0.0  0.841471</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">## 6  3  0.0  9.909297</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">## 7 -3  2.5 16.006802</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">## 8  0  2.5  5.408529</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">## 9  3  2.5 16.159297</a></code></pre></div>
</div>
<div id="start-the-optimization" class="section level3">
<h3 class="hasAnchor">
<a href="#start-the-optimization" class="anchor"></a>Start the Optimization</h3>
<p>The optimization with mlrMBO gets started as usually:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/makeMBOControl.html">makeMBOControl</a></span>()</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/setMBOControlInfill.html">setMBOControlInfill</a></span>(ctrl, <span class="dt">crit =</span> crit.ei)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/setMBOControlTermination.html">setMBOControlTermination</a></span>(ctrl, <span class="dt">iters =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="kw">configureMlr</span>(<span class="dt">show.info =</span> <span class="ot">FALSE</span>, <span class="dt">show.learner.output =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">run =<span class="st"> </span><span class="kw"><a href="../../reference/mbo.html">mbo</a></span>(<span class="dt">fun =</span> fn, <span class="dt">control =</span> ctrl)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">## Computing y column(s) for design. Not provided.</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">## [mbo] 0: x1=-0.534; x2=-1.38 : y = 1.2 : 0.0 secs : initdesign</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">## [mbo] 0: x1=1.06; x2=-0.698 : y = 1.66 : 0.0 secs : initdesign</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">## [mbo] 0: x1=-0.795; x2=0.0285 : y = 0.343 : 0.0 secs : initdesign</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">## [mbo] 0: x1=0.396; x2=1.18 : y = 0.988 : 0.0 secs : initdesign</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">## [mbo] 0: x1=1.91; x2=-0.34 : y = 4.57 : 0.0 secs : initdesign</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">## [mbo] 0: x1=-2.28; x2=1.53 : y = 7.7 : 0.0 secs : initdesign</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">## [mbo] 0: x1=2.76; x2=2.23 : y = 13.6 : 0.0 secs : initdesign</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">## [mbo] 0: x1=-2.17; x2=-1.94 : y = 8.51 : 0.0 secs : initdesign</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">## [mbo] 1: x1=-0.0992; x2=0.0458 : y = 0.879 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">## [mbo] 2: x1=-0.632; x2=2.5 : y = 5.65 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">## [mbo] 3: x1=0.481; x2=-0.00433 : y = 0.265 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">## [mbo] 4: x1=0.646; x2=0.47 : y = 0.291 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">## [mbo] 5: x1=0.597; x2=-2.5 : y = 6.21 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">## [mbo] 6: x1=-0.675; x2=-0.516 : y = 0.273 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">## [mbo] 7: x1=0.428; x2=0.383 : y = 0.211 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">## [mbo] 8: x1=-0.928; x2=-0.716 : y = 0.436 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-23" data-line-number="23">## [mbo] 9: x1=0.514; x2=0.281 : y = 0.124 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">## [mbo] 10: x1=0.516; x2=0.608 : y = 0.171 : 0.0 secs : infill_ei</a>
<a class="sourceLine" id="cb7-25" data-line-number="25"><span class="co"># The resulting optimal configuration:</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">run<span class="op">$</span>x</a>
<a class="sourceLine" id="cb7-27" data-line-number="27">## $x1</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">## [1] 0.5141354</a>
<a class="sourceLine" id="cb7-29" data-line-number="29">## </a>
<a class="sourceLine" id="cb7-30" data-line-number="30">## $x2</a>
<a class="sourceLine" id="cb7-31" data-line-number="31">## [1] 0.2805097</a>
<a class="sourceLine" id="cb7-32" data-line-number="32"><span class="co"># The best reached value:</span></a>
<a class="sourceLine" id="cb7-33" data-line-number="33">run<span class="op">$</span>y</a>
<a class="sourceLine" id="cb7-34" data-line-number="34">## [1] 0.1239528</a></code></pre></div>
</div>
</div>
<div id="execute-the-r-script-from-a-shell" class="section level2">
<h2 class="hasAnchor">
<a href="#execute-the-r-script-from-a-shell" class="anchor"></a>Execute the R script from a shell</h2>
<p>To start the optimization from a command line we have to write a R-script that also serves as the configuration for mlrMBO.</p>
<p>The following is a complete script based on the examples given above that accepts some basic arguments and writes the output as a JSON file.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">library</span>(mlrMBO)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw">library</span>(stringi)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw">library</span>(jsonlite)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co"># read command line args (in a not very safe way)</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co"># Script can be called like that:</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co"># Rscript runMBO.R iters=20 time=10 seed=1</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">args =<span class="st"> </span><span class="kw">commandArgs</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co"># defaults:</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">iters =<span class="st"> </span><span class="dv">50</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">time =<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">seed =<span class="st"> </span><span class="dv">123</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co"># parse args (and possibly overwrite defaults)</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="cf">for</span> (arg <span class="cf">in</span> args) {</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">  <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> arg))</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb8-17" data-line-number="17"><span class="kw">set.seed</span>(seed)</a>
<a class="sourceLine" id="cb8-18" data-line-number="18"></a>
<a class="sourceLine" id="cb8-19" data-line-number="19"><span class="co"># write bash script</span></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">lines =<span class="st"> '#!/bin/bash</span></a>
<a class="sourceLine" id="cb8-21" data-line-number="21"><span class="st">fun ()</span></a>
<a class="sourceLine" id="cb8-22" data-line-number="22"><span class="st">{</span></a>
<a class="sourceLine" id="cb8-23" data-line-number="23"><span class="st">  x1=$1</span></a>
<a class="sourceLine" id="cb8-24" data-line-number="24"><span class="st">  x2=$2</span></a>
<a class="sourceLine" id="cb8-25" data-line-number="25"><span class="st">  command="(s($x1-1) + ($x1^2 + $x2^2))"</span></a>
<a class="sourceLine" id="cb8-26" data-line-number="26"><span class="st">  result=$(bc -l &lt;&lt;&lt; $command)</span></a>
<a class="sourceLine" id="cb8-27" data-line-number="27"><span class="st">}</span></a>
<a class="sourceLine" id="cb8-28" data-line-number="28"><span class="st">echo "Start calculation."</span></a>
<a class="sourceLine" id="cb8-29" data-line-number="29"><span class="st">fun $1 $2</span></a>
<a class="sourceLine" id="cb8-30" data-line-number="30"><span class="st">echo "The result is $result!" &gt; "result.txt"</span></a>
<a class="sourceLine" id="cb8-31" data-line-number="31"><span class="st">echo "Finish calculation."</span></a>
<a class="sourceLine" id="cb8-32" data-line-number="32"><span class="st">'</span></a>
<a class="sourceLine" id="cb8-33" data-line-number="33"><span class="kw">writeLines</span>(lines, <span class="st">"fun.sh"</span>)</a>
<a class="sourceLine" id="cb8-34" data-line-number="34"><span class="kw">system</span>(<span class="st">"chmod +x fun.sh"</span>)</a>
<a class="sourceLine" id="cb8-35" data-line-number="35"></a>
<a class="sourceLine" id="cb8-36" data-line-number="36"><span class="co"># runScript function to execute bash script</span></a>
<a class="sourceLine" id="cb8-37" data-line-number="37">runScript =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb8-38" data-line-number="38">  <span class="co"># console output file output_1490030005_1.1_2.4.txt</span></a>
<a class="sourceLine" id="cb8-39" data-line-number="39">  output_file =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">"output_%i_%.1f_%.1f.txt"</span>, <span class="kw">as.integer</span>(<span class="kw">Sys.time</span>()), x[[<span class="st">'x1'</span>]], x[[<span class="st">'x2'</span>]])</a>
<a class="sourceLine" id="cb8-40" data-line-number="40">  <span class="co"># redirect output with ./fun.sh 1.1 2.4 &gt; output.txt</span></a>
<a class="sourceLine" id="cb8-41" data-line-number="41">  <span class="co"># alternative: ./fun.sh 1.1 2.4 &gt; /dev/null to drop it</span></a>
<a class="sourceLine" id="cb8-42" data-line-number="42">  command =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">"./fun.sh %f %f &gt; %s"</span>, x[[<span class="st">'x1'</span>]], x[[<span class="st">'x2'</span>]], output_file)</a>
<a class="sourceLine" id="cb8-43" data-line-number="43">  error.code =<span class="st"> </span><span class="kw">system</span>(command)</a>
<a class="sourceLine" id="cb8-44" data-line-number="44">  <span class="cf">if</span> (error.code <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb8-45" data-line-number="45">    <span class="kw">stop</span>(<span class="st">"Simulation had error.code != 0!"</span>)</a>
<a class="sourceLine" id="cb8-46" data-line-number="46">  }</a>
<a class="sourceLine" id="cb8-47" data-line-number="47">  result =<span class="st"> </span><span class="kw">readLines</span>(<span class="st">"result.txt"</span>)</a>
<a class="sourceLine" id="cb8-48" data-line-number="48">  <span class="co"># the pattern matches 12 as well as 12.34 and .34</span></a>
<a class="sourceLine" id="cb8-49" data-line-number="49">  <span class="co"># the ?: makes the decimals a non-capturing group.</span></a>
<a class="sourceLine" id="cb8-50" data-line-number="50">  result =<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringi/topics/stri_match">stri_match_first_regex</a></span>(result, <span class="dt">pattern =</span> <span class="st">"</span><span class="ch">\\</span><span class="st">d*(?:</span><span class="ch">\\</span><span class="st">.</span><span class="ch">\\</span><span class="st">d+)?(?=</span><span class="ch">\\</span><span class="st">!)"</span>)</a>
<a class="sourceLine" id="cb8-51" data-line-number="51">  <span class="kw">as.numeric</span>(result)</a>
<a class="sourceLine" id="cb8-52" data-line-number="52">}</a>
<a class="sourceLine" id="cb8-53" data-line-number="53"></a>
<a class="sourceLine" id="cb8-54" data-line-number="54"><span class="co"># define mlrMBO optimization</span></a>
<a class="sourceLine" id="cb8-55" data-line-number="55">par.set =<span class="st"> </span><span class="kw">makeParamSet</span>(</a>
<a class="sourceLine" id="cb8-56" data-line-number="56">  <span class="kw">makeNumericParam</span>(<span class="st">"x1"</span>, <span class="dt">lower =</span> <span class="dv">-3</span>, <span class="dt">upper =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb8-57" data-line-number="57">  <span class="kw">makeNumericParam</span>(<span class="st">"x2"</span>, <span class="dt">lower =</span> <span class="fl">-2.5</span>, <span class="dt">upper =</span> <span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb8-58" data-line-number="58">)</a>
<a class="sourceLine" id="cb8-59" data-line-number="59">fn =<span class="st"> </span><span class="kw">makeSingleObjectiveFunction</span>(</a>
<a class="sourceLine" id="cb8-60" data-line-number="60">  <span class="dt">id =</span> <span class="st">"fun.sh"</span>,</a>
<a class="sourceLine" id="cb8-61" data-line-number="61">  <span class="dt">fn =</span> runScript,</a>
<a class="sourceLine" id="cb8-62" data-line-number="62">  <span class="dt">par.set =</span> par.set,</a>
<a class="sourceLine" id="cb8-63" data-line-number="63">  <span class="dt">has.simple.signature =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-64" data-line-number="64">)</a>
<a class="sourceLine" id="cb8-65" data-line-number="65">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/makeMBOControl.html">makeMBOControl</a></span>()</a>
<a class="sourceLine" id="cb8-66" data-line-number="66">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/setMBOControlInfill.html">setMBOControlInfill</a></span>(ctrl, <span class="dt">crit =</span> crit.ei)</a>
<a class="sourceLine" id="cb8-67" data-line-number="67">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/setMBOControlTermination.html">setMBOControlTermination</a></span>(ctrl, <span class="dt">iters =</span> iters, <span class="dt">time.budget =</span> time)</a>
<a class="sourceLine" id="cb8-68" data-line-number="68"><span class="kw">configureMlr</span>(<span class="dt">show.info =</span> <span class="ot">FALSE</span>, <span class="dt">show.learner.output =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb8-69" data-line-number="69">run =<span class="st"> </span><span class="kw"><a href="../../reference/mbo.html">mbo</a></span>(<span class="dt">fun =</span> fn, <span class="dt">control =</span> ctrl)</a>
<a class="sourceLine" id="cb8-70" data-line-number="70"></a>
<a class="sourceLine" id="cb8-71" data-line-number="71"><span class="co"># clean up intermediate files:</span></a>
<a class="sourceLine" id="cb8-72" data-line-number="72"><span class="kw">file.remove</span>(<span class="st">"result.txt"</span>)</a>
<a class="sourceLine" id="cb8-73" data-line-number="73">output.files =<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">pattern =</span> <span class="st">"output_</span><span class="ch">\\</span><span class="st">d+_[0-9_.-]+</span><span class="ch">\\</span><span class="st">.txt"</span>)</a>
<a class="sourceLine" id="cb8-74" data-line-number="74"><span class="kw">file.remove</span>(output.files)</a>
<a class="sourceLine" id="cb8-75" data-line-number="75"></a>
<a class="sourceLine" id="cb8-76" data-line-number="76"><span class="co"># save result to json</span></a>
<a class="sourceLine" id="cb8-77" data-line-number="77"><span class="kw"><a href="http://www.rdocumentation.org/packages/jsonlite/topics/read_json">write_json</a></span>(run[<span class="kw">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>)], <span class="st">"mbo_res.json"</span>)</a></code></pre></div>
<p>Assuming we saved the lines above in a file called <code>runMBO.R</code>, we can simply run it from the command line as follows:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="ex">Rscript</span> runMBO.R</a></code></pre></div>
<p>As the script also handles some additional arguments it can also be called with the number of MBO iterations (<code>iters</code>), the maximal time budget in seconds (<code>time</code>) and a <code>seed</code> value for reproducibility.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="ex">Rscript</span> runMBO.R iters=20 time=10 seed=3</a></code></pre></div>
<p>To build a more advanced command line interface you might want to have a <a href="https://www.slideshare.net/EdwindeJonge1/docopt-user2014">look</a> <a href="https://github.com/docopt/docopt.R">at</a> <a href="https://cran.r-project.org/package=docopt">docopt</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#optimizing-an-algorithm-via-an-cli">Optimizing an algorithm via an CLI</a></li>
      <li><a href="#execute-the-r-script-from-a-shell">Execute the R script from a shell</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bernd Bischl, Jakob Richter, Jakob Bossek, Daniel Horn, Michel Lang, Janek Thomas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
