<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mixed Space Optimization • mlrMBO</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">mlrMBO</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/mlrMBO.html">
    <span class="fa fa-bolt"></span>
     
    Quickstart
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-text-o"></span>
     
    Topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mixed_space_optimization.html">Mixed Space Optimization</a>
    </li>
    <li>
      <a href="../articles/parallelization.html">Parallelization</a>
    </li>
    <li>
      <a href="../articles/noisy_optimization.html">Noisy Optimization</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-book"></span>
     
    Reference
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mlr-org/mlrMBO">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Mixed Space Optimization</h1>
            
          </div>

    
    
<div class="contents">
<div id="purpose" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#purpose" class="anchor"> </a></body></html>Purpose</h2>
<p>This Vignette is supposed to give you an introduction to use <strong>mlrMBO</strong> for mixed-space optimization, meaning to optimize an objective function with a domain that is not only real-valued but also contains discrete values like <em>names</em>.</p>
</div>
<div id="mixed-space-optimization" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#mixed-space-optimization" class="anchor"> </a></body></html>Mixed Space Optimization</h2>
<div id="objective-function" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#objective-function" class="anchor"> </a></body></html>Objective Function</h3>
<p>We construct an exemplary objective function using <code>smoof::makeSingleObjetiveFunction()</code>. The <code>par.set</code> argument has to be a <code>ParamSet</code> object from the <strong>ParamHelpers</strong> package, which provides information about the parameters of the objective function and their constraints for optimization. The objective function will be 3-dimensional with the inputs <code>j</code> and <code>method</code>. <code>j</code> is in the interval <span class="math inline">\([0,2\pi]\)</span> The Parameter <code>method</code> is categorical and can be either <code>"a"</code> or <code>"b"</code>. In this case we want to minimize the function, so we have to set <code>minimize = TRUE</code>. As the parameters are of different types (e.g. numeric and categorical), the function expects a list instead of a vector as its argument, which is specified by <code>has.simple.signature = FALSE</code>. For further information about he <strong>smoof</strong> package we refer to the <a href="https://github.com/jakobbossek/smoof">github page</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(mlrMBO)
<span class="kw">library</span>(ggplot2)

fun =<span class="st"> </span><span class="cf">function</span>(x) {
  j =<span class="st"> </span>x<span class="op">$</span>j
  method =<span class="st"> </span>x<span class="op">$</span>method
  perf =<span class="st"> </span><span class="kw">ifelse</span>(method <span class="op">==</span><span class="st"> "a"</span>, <span class="kw">sin</span>(j), <span class="kw">cos</span>(j))
  <span class="kw">return</span>(perf)
}

objfun2 =<span class="st"> </span><span class="kw">makeSingleObjectiveFunction</span>(
  <span class="dt">name =</span> <span class="st">"mixed_example"</span>,
  <span class="dt">fn =</span> fun,
  <span class="dt">par.set =</span> <span class="kw">makeParamSet</span>(
    <span class="kw">makeNumericParam</span>(<span class="st">"j"</span>, <span class="dt">lower =</span> <span class="dv">0</span>,<span class="dt">upper =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>pi),
    <span class="kw">makeDiscreteParam</span>(<span class="st">"method"</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>))
  ),
  <span class="dt">has.simple.signature =</span> <span class="ot">FALSE</span>,
  <span class="dt">minimize =</span> <span class="ot">TRUE</span>
)

<span class="co"># visualize the function</span>
<span class="kw">autoplot</span>(objfun2)</code></pre></div>
<p><img src="mixed_space_optimization_files/figure-html/objective_function-1.png" width="672"></p>
</div>
<div id="sorrogate-learner" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#sorrogate-learner" class="anchor"> </a></body></html>Sorrogate Learner</h3>
<p>For this kind of parameter space a regression method for the surrogate is necessary that supports <em>factors</em>. To list all <em>mlr</em> learners that support factors and uncertainty estimation you can run <code>listLearners("regr", properties = c("factors", "se"))</code>. A popular choice for these scenarios is the <em>Random Forest</em>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">surr.rf =<span class="st"> </span><span class="kw">makeLearner</span>(<span class="st">"regr.randomForest"</span>, <span class="dt">predict.type =</span> <span class="st">"se"</span>)</code></pre></div>
</div>
<div id="infill-criterion" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#infill-criterion" class="anchor"> </a></body></html>Infill Criterion</h3>
<p>Although technically possible the <em>Expected Imrovement</em> that we used for the numerical parameter space and the <em>Kriging</em> surrogate, the <em>Confidence Bound</em> (<code><a href="../reference/infillcrits.html">makeMBOInfillCritCB()</a></code>) or also called statistical upper/lower bound is recommended for <em>Random Forest</em> regression. The reason is, that the <em>Expected Improvement</em> is founded on the Gaussian posterior distribution given by the Kriging estimator, which is not given by the Random Forest regression. For <em>minimization</em> the <em>lower</em> Confidence Bound is given by <span class="math inline">\(UCB(x) = \hat{\mu}(x) - \lambda \cdot \hat{s}(x)\)</span>. We set <span class="math inline">\(\lambda = 5\)</span>. For the infill criteria optimization we set <code>opt.focussearch.points = 500</code>, to increase the speed of the tutorial.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">control2 =<span class="st"> </span><span class="kw"><a href="../reference/makeMBOControl.html">makeMBOControl</a></span>()
control2 =<span class="st"> </span><span class="kw"><a href="../reference/setMBOControlInfill.html">setMBOControlInfill</a></span>(
  <span class="dt">control =</span> control2,
  <span class="dt">crit =</span> <span class="kw"><a href="../reference/infillcrits.html">makeMBOInfillCritCB</a></span>(<span class="dt">cb.lambda =</span> <span class="dv">5</span>),
  <span class="dt">opt.focussearch.points =</span> <span class="dv">500</span>
)</code></pre></div>
</div>
<div id="termination" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#termination" class="anchor"> </a></body></html>Termination</h3>
<p>We want to stop after 10 MBO iterations, meaning 10 function evaluations in this example (not including the initial design):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">control2 =<span class="st"> </span><span class="kw"><a href="../reference/setMBOControlTermination.html">setMBOControlTermination</a></span>(
  <span class="dt">control =</span> control2,
  <span class="dt">iters =</span> <span class="dv">10</span>
)</code></pre></div>
</div>
<div id="initial-design" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#initial-design" class="anchor"> </a></body></html>Initial Design</h3>
<p>The initial design is set to size of 8:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">design2 =<span class="st"> </span><span class="kw">generateDesign</span>(<span class="dt">n =</span> <span class="dv">8</span>, <span class="dt">par.set =</span> <span class="kw">getParamSet</span>(objfun2))</code></pre></div>
<p>Note that the initial design has to be big enough to cover all discrete values and ideally all combinations of discrete values including integers. If we had 2 discrete variables one with 5 and one with 3 discrete values the initial design should be at least of size 15. Usually <code>generateDesign()</code> takes care that the points are spread uniformly.</p>
</div>
<div id="optimization" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#optimization" class="anchor"> </a></body></html>Optimization</h3>
<p>Finally, we start the optimization with <code><a href="../reference/mbo.html">mbo()</a></code> with suppressed learner output from <em>mlr</em> and we print the result object to obtain the input that lead to the best objective:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Surpresses output of learners</span>
mlr<span class="op">::</span><span class="kw">configureMlr</span>(<span class="dt">show.info =</span> <span class="ot">FALSE</span>, <span class="dt">show.learner.output =</span> <span class="ot">FALSE</span>, <span class="dt">on.learner.warning =</span> <span class="st">"quiet"</span>)
run2 =<span class="st"> </span><span class="kw"><a href="../reference/mbo.html">mbo</a></span>(objfun2, <span class="dt">design =</span> design2, <span class="dt">learner =</span> surr.rf, <span class="dt">control =</span> control2, <span class="dt">show.info =</span> <span class="ot">TRUE</span>)
## Computing y column(s) for design. Not provided.
## [mbo] 0: j=4.12; method=b : y = -0.558 : 0.0 secs : initdesign
## [mbo] 0: j=0.033; method=a : y = 0.033 : 0.0 secs : initdesign
## [mbo] 0: j=1.83; method=a : y = 0.967 : 0.0 secs : initdesign
## [mbo] 0: j=5.46; method=a : y = -0.732 : 0.0 secs : initdesign
## [mbo] 0: j=1.48; method=b : y = 0.0866 : 0.0 secs : initdesign
## [mbo] 0: j=2.9; method=b : y = -0.971 : 0.0 secs : initdesign
## [mbo] 0: j=6; method=b : y = 0.96 : 0.0 secs : initdesign
## [mbo] 0: j=3.92; method=a : y = -0.704 : 0.0 secs : initdesign
## [mbo] 1: j=6.13; method=b : y = 0.988 : 0.0 secs : infill_cb
## [mbo] 2: j=5.54; method=b : y = 0.735 : 0.0 secs : infill_cb
## [mbo] 3: j=2.82; method=b : y = -0.95 : 0.0 secs : infill_cb
## [mbo] 4: j=2.23; method=a : y = 0.789 : 0.0 secs : infill_cb
## [mbo] 5: j=5.44; method=a : y = -0.744 : 0.0 secs : infill_cb
## [mbo] 6: j=2.54; method=b : y = -0.824 : 0.0 secs : infill_cb
## [mbo] 7: j=2.37; method=a : y = 0.697 : 0.0 secs : infill_cb
## [mbo] 8: j=5.42; method=a : y = -0.759 : 0.0 secs : infill_cb
## [mbo] 9: j=2.6; method=b : y = -0.856 : 0.0 secs : infill_cb
## [mbo] 10: j=5.49; method=a : y = -0.71 : 0.0 secs : infill_cb</code></pre></div>
<p>The console output gives a live overview of all all evaluated points.</p>
<p>Let’s look at the parts of the result that tell us the optimal reached value and its corresponding setting:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">run2<span class="op">$</span>y
run2<span class="op">$</span>x
## [1] -0.9710349
## $j
## [1] 2.900321
## 
## $method
## [1] "b"</code></pre></div>
</div>
</div>
<div id="visualization" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#visualization" class="anchor"> </a></body></html>Visualization</h2>
<p>Visualization is only possible for 2-dimensional objective functions, of which one is the categorical dimension. Exactly like in our exemplary function.</p>
<p>Again, to obtain all the data that is necessary to generate the plot we have to call the optimization through <code><a href="../reference/exampleRun.html">exampleRun()</a></code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ex.run2 =<span class="st"> </span><span class="kw"><a href="../reference/exampleRun.html">exampleRun</a></span>(objfun2, <span class="dt">design =</span> design2, <span class="dt">learner =</span> surr.rf, <span class="dt">control =</span> control2, <span class="dt">show.info =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p>And let’s visualize the results:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plotExampleRun.html">plotExampleRun</a></span>(ex.run2, <span class="dt">iters =</span> <span class="kw">c</span>(1L, 2L, 10L), <span class="dt">pause =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p><img src="mixed_space_optimization_files/figure-html/plot_example_run_2d-1.png" width="672"><img src="mixed_space_optimization_files/figure-html/plot_example_run_2d-2.png" width="672"><img src="mixed_space_optimization_files/figure-html/plot_example_run_2d-3.png" width="672"></p>
</div>
<div id="improved-example-for-dependent-parameters" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#improved-example-for-dependent-parameters" class="anchor"> </a></body></html>Improved Example for Dependent Parameters</h2>
<p>Looking back at our example we notice that the behavior of the function for <span class="math inline">\(j\)</span> totally changes depending on the chosen <em>method</em>. If such dependency is known beforehand it totally makes sense to let the surrogate know that <span class="math inline">\(j\)</span> should be treated differently depending on the chosen <em>method</em>. This is done by introducing a new variable for each <em>method</em>. Assuming we can not change the objective function <code>fun</code> we can easily build a <em>wrapper</em> to achieve that.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wrap.fun =<span class="st"> </span><span class="cf">function</span>(x) {
  x<span class="op">$</span>j =<span class="st"> </span><span class="cf">if</span> (x<span class="op">$</span>method <span class="op">==</span><span class="st"> "a"</span>) x<span class="op">$</span>ja <span class="cf">else</span> x<span class="op">$</span>jb
  x =<span class="st"> </span><span class="kw">dropNamed</span>(x, <span class="kw">c</span>(<span class="st">"ja"</span>, <span class="st">"jb"</span>))
  <span class="kw">fun</span>(x)
}</code></pre></div>
<p>We have to also change the parameter space accordingly:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ps.wrap =<span class="st"> </span><span class="kw">makeParamSet</span>(
  <span class="kw">makeDiscreteParam</span>(<span class="st">"method"</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>)),
  <span class="kw">makeNumericParam</span>(<span class="st">"ja"</span>, <span class="dt">lower =</span> <span class="dv">0</span>,<span class="dt">upper =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>pi, <span class="dt">requires =</span> <span class="kw">quote</span>(method <span class="op">==</span><span class="st"> "a"</span>)),
  <span class="kw">makeNumericParam</span>(<span class="st">"jb"</span>, <span class="dt">lower =</span> <span class="dv">0</span>,<span class="dt">upper =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>pi, <span class="dt">requires =</span> <span class="kw">quote</span>(method <span class="op">==</span><span class="st"> "b"</span>))
  )</code></pre></div>
<p>Let’s wrap this up in a new objective function using <code>smoof</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">objfun3 =<span class="st"> </span><span class="kw">makeSingleObjectiveFunction</span>(
  <span class="dt">name =</span> <span class="st">"mixed_example: Dependent J"</span>,
  <span class="dt">fn =</span> wrap.fun,
  <span class="dt">par.set =</span> ps.wrap,
  <span class="dt">has.simple.signature =</span> <span class="ot">FALSE</span>,
  <span class="dt">minimize =</span> <span class="ot">TRUE</span>
)</code></pre></div>
<p>And now let’s directly run the optimization without further changing the control object from above:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">design3 =<span class="st"> </span><span class="kw">generateDesign</span>(<span class="dt">n =</span> <span class="dv">8</span>, <span class="dt">par.set =</span> <span class="kw">getParamSet</span>(objfun3))
run3 =<span class="st"> </span><span class="kw"><a href="../reference/mbo.html">mbo</a></span>(objfun3, <span class="dt">design =</span> design3, <span class="dt">control =</span> control2, <span class="dt">show.info =</span> <span class="ot">FALSE</span>)
run3<span class="op">$</span>x
run3<span class="op">$</span>y
## $method
## [1] "a"
## 
## $ja
## [1] 4.964501
## 
## $jb
## [1] NA
## 
## [1] -0.9683878</code></pre></div>
<p>Unfortunately our problem is now categorical and 3-dimensional to the eyes of <code>mlrMBO</code> so there is no implemented method to visualize the optimization. However we can analyze the residuals to see which surrogate was more accurate:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">op2 =<span class="st"> </span><span class="kw">as.data.frame</span>(run2<span class="op">$</span>opt.path)
op3 =<span class="st"> </span><span class="kw">as.data.frame</span>(run3<span class="op">$</span>opt.path)

<span class="co"># residual variance of the surrogate model for the first example</span>
<span class="kw">var</span>(op2<span class="op">$</span>mean <span class="op">-</span><span class="st"> </span>op2<span class="op">$</span>y, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
<span class="co"># residual variance of the advanced surrogate model with independetly treat ed jaand jb</span>
<span class="kw">var</span>(op3<span class="op">$</span>mean <span class="op">-</span><span class="st"> </span>op3<span class="op">$</span>y, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
## [1] 0.5208306
## [1] 0.2127401</code></pre></div>
<p>As you can see our new approach could improve the accuracy of the surrogate.</p>
</div>
<div id="remarks" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#remarks" class="anchor"> </a></body></html>Remarks</h2>
<p>In comparison to optimization on a purely numerical search space with functions that are not too crazy mixed space optimization comes with some twists that we want to mention here.</p>
<div id="random-forests-as-surrogate" class="section level3">
<h3 class="hasAnchor">
<html><body><a href="#random-forests-as-surrogate" class="anchor"> </a></body></html>Random Forests as surrogate</h3>
<p>The biggest drawback of using <em>random forests</em> versus <em>Kriging</em> is the lack of <em>“spacial uncertainty”</em>. Whereas in Kriging can model uncertainty in areas where no observations are made thanks to the co-variance that gets higher for points that are far away from already visited points, the random forest lacks of this information. For the random forest the uncertainty is based on the diversity of the results of the individual individual forests. Naturally, the diversity is higher in areas where the results of the objective function are diverse. For deterministic functions or functions with just a little noise this is mainly the case in the proximity of steep slopes of the objective function. This can lead to proposed points that are located at slopes but not actually in the <em>valley</em>. Furthermore the diversity of the prediction of the individual trees can also be quite low outside the area of observed values leading to less proposals in the area between proposed points and the actual boundaries of the search space. To combat this problem it can make sense to manually add points at the boundaries of the search space to the initial design.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#purpose">Purpose</a></li>
      <li><a href="#mixed-space-optimization">Mixed Space Optimization</a></li>
      <li><a href="#visualization">Visualization</a></li>
      <li><a href="#improved-example-for-dependent-parameters">Improved Example for Dependent Parameters</a></li>
      <li><a href="#remarks">Remarks</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bernd Bischl, Jakob Bossek, Jakob Richter, Daniel Horn, Michel Lang, Janek Thomas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
